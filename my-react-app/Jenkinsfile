pipeline {
    agent any

    environment {
        VERCEL_TOKEN = credentials('vercel-token')
        VERCEL_ORG = 'potterpurpps-projects'
        DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1301119066265747517/2YJCuNJJO-JlYJ9fUQK7_c_xTUj-Jasv97RiO7Fyb7Y9qPtEtsxNolQKAE4QKaNEszj1'
        TEAMS_WEBHOOK_URL = 'https://bluebikgroupoutlookcom.webhook.office.com/webhookb2/145186be-7da8-49ca-ae1f-04113cb2f86b@c6f661d6-c0e6-4a9b-beee-5dda4af7788b/IncomingWebhook/b2c70ed0cf10420d9443e8055e9ef101/b90aed23-9e60-4dd0-8400-4a9574103f9a/V2IcFDTMgzoWlVX6CHTFhp9QyRSAf_FDo4t7s6EkCra1E1'
    }
    stages {
        stage('Checkout') {
            steps {
                echo "Hello World!"
                git branch: 'main', url: 'https://github.com/Potterpurpp/potteraomfree.git' 
            }
        }
        stage('Install Dependencies') {
            steps {
                dir('my-react-app') {
                    sh 'rm -rf node_modules package-lock.json'
                    sh 'npm install'
                }
            }
        }
        stage('Build') {
            steps {
                dir('my-react-app') {
                    sh 'npm run build'
                }
            }
        }
        stage('Deploy to Vercel') {
            steps {
                dir('my-react-app') {
                    // Use npx to run the Vercel CLI
                    sh 'npx vercel --token $VERCEL_TOKEN --scope $VERCEL_ORG --prod --confirm'
                }
            }
        }
         stage('Notify Discord') {
            steps {
                script {
                    def message = "Deployment to Vercel successful: ${env.BUILD_URL}"
                    sh """
                    curl -H "Content-Type: application/json" -d '{
                        "content": "${message}"
                    }' ${DISCORD_WEBHOOK_URL}
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                office365ConnectorSend (
                    webhookUrl: TEAMS_WEBHOOK_URL,
                    color: '#00ff00',
                    message: "Pipeline succeeded for build #${env.BUILD_NUMBER}",
                    status: "SUCCESS"
                )
            }
            echo 'Pipeline succeeded!'
        }
        failure {
            script {
                office365ConnectorSend (
                    webhookUrl: TEAMS_WEBHOOK_URL,
                    color: '#ff0000',
                    message: "Pipeline failed for build #${env.BUILD_NUMBER}",
                    status: "FAILURE"
                )
            }
            echo 'Pipeline failed!'
        }
        unstable {
            script {
                office365ConnectorSend (
                    webhookUrl: TEAMS_WEBHOOK_URL,
                    color: '#ffff00',
                    message: "Pipeline is unstable for build #${env.BUILD_NUMBER}",
                    status: "UNSTABLE"
                )
            }
            echo 'Pipeline is unstable!'
        }
        aborted {
            script {
                office365ConnectorSend (
                    webhookUrl: env.TEAMS_WEBHOOK_URL,
                    color: '#0000ff',
                    message: "Pipeline was aborted for build #${env.BUILD_NUMBER}",
                    status: "ABORTED"
                )
            }
            echo 'Pipeline aborted!'
        }
        cleanup {
            cleanWs(cleanWhenNotBuilt: false,
                    deleteDirs: true,
                    disableDeferredWipeout: true,
                    notFailBuild: true,
                    patterns: [[pattern: '.gitignore', type: 'INCLUDE'],
                            [pattern: '.propsfile', type: 'EXCLUDE']])
        }
    }
} 
